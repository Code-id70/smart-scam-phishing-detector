document.getElementById('analysis-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const message = document.getElementById('message').value;
    const url = document.getElementById('url').value;

    fetch('/analyze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message, url: url }),
    })
    .then(response => response.json())
    .then(data => {
        displayResults(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while analyzing the message.');
    });
});

function displayResults(data) {
    const resultsDiv = document.getElementById('results');
    const riskLevelDiv = document.getElementById('risk-level');
    const riskIcon = document.getElementById('risk-icon');
    const confidenceDiv = document.getElementById('confidence');
    const explanationsUl = document.getElementById('explanations');
    const tipsUl = document.getElementById('tips');

    riskLevelDiv.textContent = `Risk Level: ${data.risk_level}`;
    riskLevelDiv.className = data.risk_level.toLowerCase() + '-risk';

    // Add risk icon
    const icons = {
        'Low': 'ðŸŸ¢',
        'Medium': 'ðŸŸ¡',
        'High': 'ðŸ”´'
    };
    riskIcon.textContent = icons[data.risk_level] || 'âš ï¸';

    confidenceDiv.textContent = `Approximate Confidence: ${data.confidence}%`;

    explanationsUl.innerHTML = '';
    data.explanations.forEach(exp => {
        const li = document.createElement('li');
        li.textContent = exp;
        explanationsUl.appendChild(li);
    });

    tipsUl.innerHTML = '';
    data.tips.forEach(tip => {
        const li = document.createElement('li');
        li.textContent = tip;
        tipsUl.appendChild(li);
    });

    resultsDiv.style.display = 'block';
}

function loadExample(type) {
    const examples = {
        'phishing': {
            message: 'URGENT! Your account has been suspended. Click here to verify: http://bit.ly/verify',
            url: 'http://bit.ly/verify'
        },
        'suspicious': {
            message: 'Congratulations! You won $1000. Update your payment info to claim.',
            url: ''
        },
        'legitimate': {
            message: 'Hi, your order has been shipped. Track it here: https://amazon.com/tracking',
            url: 'https://amazon.com/tracking'
        }
    };

    const example = examples[type];
    document.getElementById('message').value = example.message;
    document.getElementById('url').value = example.url;
}

function exportResults() {
    const riskLevel = document.getElementById('risk-level').textContent;
    const confidence = document.getElementById('confidence').textContent;
    const explanations = Array.from(document.querySelectorAll('#explanations li')).map(li => li.textContent);
    const tips = Array.from(document.querySelectorAll('#tips li')).map(li => li.textContent);

    const exportText = `
Scam & Phishing Risk Assessment

${riskLevel}
${confidence}

Explanations:
${explanations.map(exp => `- ${exp}`).join('\n')}

Safety Tips:
${tips.map(tip => `- ${tip}`).join('\n')}

Generated by Smart Scam & Phishing Risk Detector
    `.trim();

    const blob = new Blob([exportText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'risk-assessment.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}